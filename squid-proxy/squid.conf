# =========================================
# Squid Proxy Server Configuration
# =========================================

# -------------------------------
# Listen on all network interfaces
# -------------------------------
http_port 3128

# -------------------------------
# Cache tuning (adjust per server RAM/disk)
# -------------------------------
cache_mem 512 MB                       # RAM cache for small objects
maximum_object_size_in_memory 64 KB    # max object in RAM
cache_dir ufs /var/spool/squid 20000 16 256   # 20 GB disk cache
maximum_object_size 1024 MB            # max object on disk

# -------------------------------
# Source ACLs - define who can use the proxy
# -------------------------------
acl localhost src 127.0.0.1/32 ::1
acl lan1 src 192.168.12.0/24           # LAN subnet 1
acl lan2 src 172.29.236.0/24           # LAN subnet 2

# -------------------------------
# HTTP Methods ACL
# -------------------------------
acl CONNECT method CONNECT             # required for HTTPS CONNECT

# -------------------------------
# Destination ACL - whitelist
# -------------------------------
# Only allow access to these domains
acl allowed_sites dstdomain "/etc/squid/whitelist.txt"

# -------------------------------
# Ports ACL
# -------------------------------
acl SSL_ports port 443                  # HTTPS
acl Safe_ports port 80 443 21           # HTTP, HTTPS, FTP

# -------------------------------
# Access rules
# -------------------------------
# 1. Deny requests to unsafe ports
http_access deny !Safe_ports

# 2. Deny CONNECT to non-SSL ports
http_access deny CONNECT !SSL_ports

# 3. Allow proxy manager interface from localhost only
http_access allow manager localhost
http_access deny manager

# 4. Always allow localhost traffic
http_access allow localhost

# 5. Allow LAN clients to access whitelisted sites (HTTP)
http_access allow lan1 allowed_sites
http_access allow lan2 allowed_sites

# 6. Allow LAN clients to CONNECT to whitelisted HTTPS sites
http_access allow lan1 CONNECT allowed_sites
http_access allow lan2 CONNECT allowed_sites

# 7. Deny everything else
http_access deny all

# -------------------------------
# Logging
# -------------------------------
access_log /var/log/squid/access.log squid
cache_log /var/log/squid/cache.log

# -------------------------------
# Refresh patterns - optimize caching for APT repos
# -------------------------------
refresh_pattern ^ftp:          1440    20%     10080
refresh_pattern ^gopher:       1440    0%      1440
refresh_pattern -i (/cgi-bin/|\?) 0    0%      0
refresh_pattern \/(Packages|Sources)(|\.bz2|\.gz|\.xz)$ 0 0% 0 refresh-ims
refresh_pattern \/Release(|\.gpg)$ 0 0% 0 refresh-ims
refresh_pattern \/InRelease$ 0 0% 0 refresh-ims
refresh_pattern \/(Translation-.*)(|\.bz2|\.gz|\.xz)$ 0 0% 0 refresh-ims
refresh_pattern . 0 20% 4320
